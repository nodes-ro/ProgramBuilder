<!doctype html>
<html data-theme="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Event Program Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" rel="stylesheet"/>

    <style>
        /* Flash messages container */
        #flash-messages {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            z-index: 9999;
            max-width: 300px;
            font-size: 0.85rem;
        }
        /* Individual flash message styling */
        .flash-msg {
            background: #f0f8ff;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Category-specific colors */
        .flash-msg.error   { border-color: #e53935; background: #ffebee; }
        .flash-msg.success { border-color: #43a047; background: #e8f5e9; }
        .flash-msg.warning { border-color: #fdd835; background: #fffde7; }
        .flash-msg.info    { border-color: #1e88e5; background: #e3f2fd; }
        /* Clear Program button: red border */
        .clear-program {
            border-color: #e53935 !important;
            color: #e53935 !important;
        }

        .page-title {
            font-size: 2rem;
            color: #5d6b89;
            padding-bottom: 0.5rem;
            border-bottom: 4px solid transparent;
            border-image: linear-gradient(to right, #5d6b89, #fff) 1;
        }

    </style>
</head>
<body class="container">
<main>
    <h2 class="page-title">Event Program Generator</h2>


    <!-- Flash messages -->
    <div id="flash-messages">
        {%- with msgs = get_flashed_messages(with_categories=true) %}
          {%- if msgs %}
            {%- for cat, msg in msgs %}
              <div class="flash-msg {{ cat }}">{{ msg }}</div>
            {%- endfor %}
          {%- endif %}
        {%- endwith %}
    </div>

    <!-- Split view: 1/3 sidebar · 2/3 schedule -->
    <div class="grid" style="grid-template-columns: 1fr 2fr; gap: var(--pico-spacing);">

        <!-- Sidebar: Forms & Controls -->
        <aside style="border-right: 1px dotted lightgray; padding-right: 1rem; background-color: var(--pico-background-color);">

            <!-- Accordion 1: Program Overview -->
            <details class="menu" aria-haspopup="true" {% if program %}disabled{% endif %}>
                <summary role="button" class="secondary outline">Program Overview</summary>
                {% if program %}
                  <p><em>A program is already active. You can add days and events to it or clear the current program.</em></p>
                  <form method="post" style="margin-top: var(--size-3);">
                      <input name="form_type" type="hidden" value="clear_program">
                      <button class="contrast outline clear-program"
                              onclick="return confirm('Are you sure you want to clear the current program?')"
                              type="submit">
                          Clear Program
                      </button>
                  </form>
                {% else %}
                  <form method="post">
                      <input name="form_type" type="hidden" value="new_program">
                      <input name="program_name" placeholder="e.g. 2025 Tech Festival" required type="text"/>
                      <button class="secondary" type="submit">Save Program</button>
                  </form>
                {% endif %}
            </details>

            <!-- Accordion 2: Add Day -->
            <details {% if not program %}disabled{% endif %}>
                <summary role="button" class="secondary outline">Add Day</summary>
                <form method="post">
                    <input name="form_type" type="hidden" value="day_schedule">

                    {% if program %}
                      <label>Your Program: <strong>{{ program.name }}</strong></label>
                    {% endif %}

                    <label for="day">Day</label>
                    <select id="day" name="day" required>
                        <option disabled selected value="">Select a day</option>
                        {% for d in days %}
                          <option value="{{ d }}">{{ d }}</option>
                        {% endfor %}
                    </select>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--pico-spacing);">
                        <label for="day_start">Day starts
                          <input id="day_start" name="day_start" required type="time" value="09:00" lang="en-GB"/>
                        </label>
                        <label for="day_ends">Day ends
                          <input id="day_ends" name="day_ends" required type="time" value="17:00" lang="en-GB"/>
                        </label>
                    </div>

                    <label for="stage-count">How many stages does your event have?</label>
                    <select id="stage-count" name="stage_count" required>
                        <option disabled selected value="">Select number of stages</option>
                        {% for i in range(1, 11) %}
                          <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>

                    <button class="secondary" type="submit">Save Day</button>
                </form>
            </details>

            <!-- Accordion 3: Add Events -->
            <details>
                <summary role="button" class="secondary outline">Add Events To Your Day</summary>
                <form enctype="multipart/form-data" method="post">
                    <input name="form_type" type="hidden" value="new_event">

                    <label>Select Day
                      <select name="day" required>
                        {% if program and program.days %}
                          {% for d in program.days %}
                            <option value="{{ d.day }}">{{ d.day }}</option>
                          {% endfor %}
                        {% else %}
                          <option disabled selected>No days available</option>
                        {% endif %}
                      </select>
                    </label>

                    <label>Select Stage
                      <select id="stage-select" name="stage" required>
                        <option disabled selected value="">Select a stage</option>
                        {% for i in range(1, 11) %}
                          <option class="stage-option" data-stage="{{ i }}" value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                      </select>
                    </label>

                    <label>Event title
                      <input name="title" placeholder="Event title" required type="text"/>
                    </label>

                    <label>Event description
                      <textarea maxlength="240" name="detail" placeholder="What happens? (max 240 chars)" required rows="2"></textarea>
                    </label>

                    <label>Event picture (optional)
                      <input accept="image/*" name="picture" type="file"/>
                    </label>

                    <label>Event starts at
                      <input name="event_start" required type="time" value="09:00" lang="en-GB"/>
                    </label>

                    <label>Event ends at
                      <input name="event_end" required type="time" value="10:00" lang="en-GB"/>
                    </label>

                    <button class="secondary" type="submit">Add Event</button>
                </form>
            </details>

            <!-- Interval Selector -->
            {% if program %}
            <br/>
            <form enctype="multipart/form-data" method="post">
                <input name="form_type" type="hidden" value="set_interval">
                {% set cur = program.get('slot_interval', 30) %}
                <details class="dropdown">
                    <summary role="button" class="outline">Time interval: {{ cur }} min</summary>
                    <ul class="interval-options">
                        {% for val, label in [(60,'60 min'),(30,'30 min'),(15,'15 min'),(10,'10 min')] %}
                          <li>
                            <button type="submit" name="slot_interval" value="{{ val }}" {% if cur == val %}aria-current="true"{% endif %}>
                              {{ label }}
                            </button>
                          </li>
                        {% endfor %}
                    </ul>
                </details>
            </form>
            {% endif %}

              {% if program %}
            <!-- Download Schedule -->
            <div style="margin-top: var(--size-3);">
                <button class="contrast outline" id="download-schedule" type="button" style="width:100%;">Download HTML</button>
            </div>
            {% endif %}
        </aside>

        <!-- Schedule Preview (2/3) -->
        <section id="export-section" style="overflow-x: auto; width: 100%; padding-left: 1rem;">
            {% include "program_template.html" %}
        </section>
    </div>
</main>

<!-- Auto-dismiss flash messages -->
<script>
    setTimeout(() => document.querySelectorAll('.flash-msg').forEach(msg => msg.remove()), 5000);
</script>

<!-- Download Schedule JS -->
<script>
    document.getElementById('download-schedule').addEventListener('click', () => {
        const content = document.getElementById('export-section').innerHTML;
        const html = `<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Exported Schedule</title><link href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" rel="stylesheet"></head><body>${content}</body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
</script>

</body>
</html>