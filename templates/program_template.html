{% macro render_event_cell(event, duration_slots) %}
  <td rowspan="{{ duration_slots }}">
    <strong title="{{ event.detail }}">{{ event.title }}</strong><br>
    <small>{{ event.event_start }} â†’ {{ event.event_end }}</small>
  </td>
{% endmacro %}

{% if program %}
  <h3>{{ program.name }}</h3>

  <!-- Tabs -->
  <nav role="tablist" class="tabs">
    <ul>
      {% for d in program.days %}
        {% set tid = d.day|lower|replace(" ", "_") %}
        <li>
          <a href="#{{ tid }}" role="tab"
             {% if loop.first %}aria-selected="true"{% endif %}>
            {{ d.day }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>

  {% set interval = program.slot_interval | default(30) %}

  {% for d in program.days %}
    {% set tid       = d.day|lower|replace(" ", "_") %}
    {% set stages    = d.stage_count|int %}
    {% set start_min = (d.day_start.split(':')[0]|int) * 60 %}
    {% set end_min   = (d.day_ends.split(':')[0]|int) * 60 %}
    {% set slots     = (end_min - start_min) // interval %}
    {% set active    = {} %}

    <section id="{{ tid }}" role="tabpanel" {% if not loop.first %}hidden{% endif %}>
<table class="fixed-table">
        <thead>
          <tr>
            <th>Time</th>
            {% for s in range(1, stages + 1) %}
              <th>Stage {{ s }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for slot in range(slots) %}
            {% set now = start_min + slot * interval %}
            <tr>
              <!-- time column -->
              <td>{{ "%02d:%02d"|format(now // 60, now % 60) }}</td>

              <!-- one cell per stage -->
              {% for s in range(1, stages + 1) %}
                {% set cell_key = d.day ~ '-' ~ s ~ '-' ~ now %}

                {# if this minute is covered by a rowspan, emit an empty <td> #}
                {% if cell_key in active %}
                  <td></td>

                {# otherwise try to render an event starting now #}
                {% else %}
                  {% set rendered = false %}
                  {% for ev in events if ev.day == d.day and ev.stage|int == s %}
                    {% set st = ev.event_start.split(':') %}
                    {% set en = ev.event_end.split(':') %}
                    {% set st_min = st[0]|int * 60 + st[1]|int %}
                    {% set en_min = en[0]|int * 60 + en[1]|int %}
                    {% set dur = (en_min - st_min) // interval %}

                    {% if st_min == now and not rendered %}
                      {{ render_event_cell(ev, dur) }}
                      {# mark covered slots #}
                      {% for i in range(1, dur) %}
                        {% set _ = active.update({ d.day ~ '-' ~ s ~ '-' ~ (now + i * interval): true }) %}
                      {% endfor %}
                      {% set rendered = true %}
                    {% endif %}
                  {% endfor %}

                  {# if no event started here, emit an empty cell #}
                  {% if not rendered %}
                    <td></td>
                  {% endif %}
                {% endif %}

              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endfor %}

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs   = document.querySelectorAll('nav[role=tablist] a');
      const panels = document.querySelectorAll('section[role=tabpanel]');
      tabs.forEach(tab => {
        tab.addEventListener('click', e => {
          e.preventDefault();
          const id = tab.getAttribute('href').substring(1);
          panels.forEach(p => p.hidden = true);
          tabs.forEach(t => t.removeAttribute('aria-selected'));
          document.getElementById(id).hidden = false;
          tab.setAttribute('aria-selected', 'true');
        });
      });
    });
  </script>

{% else %}
  <p>No program yet.</p>
{% endif %}
